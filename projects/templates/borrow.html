{% extends "base.html" %}

{% block content %}
<h2>Borrow Book</h2>
<form id="borrow-form" method="POST" action="{{ url_for('borrow') }}">
    <label for="student_code">Student Name:</label>
    <select id="student_code" name="student_code" required>
        <option value="">Select Student</option>
        {% for student in students %}
        <option value="{{ student.student_code }}" data-department="{{ student.department }}">{{ student.name }}</option>
        {% endfor %}
    </select>

    <label for="student_department">Department:</label>
    <input type="text" id="student_department" name="student_department" readonly />

    <label for="book_name">Book Name:</label>
    <input type="text" id="book_name" name="book_name" autocomplete="off" required />
    <div id="book-suggestions" class="suggestions"></div>

    <label for="borrow_date">Borrow Date:</label>
    <input type="date" id="borrow_date" name="borrow_date" required />

    <button type="submit">Borrow</button>
</form>

<script>
$(document).ready(function() {
    // Auto-fill department on student selection
    $('#student_code').change(function() {
        var department = $(this).find(':selected').data('department') || '';
        $('#student_department').val(department);
    });

    // Book auto-suggestions
    var books = [];
    $.getJSON('{{ url_for("get_books") }}', function(data) {
        books = data.books;
    });

    $('#book_name').on('input', function() {
        var query = $(this).val().toLowerCase();
        var suggestions = books.filter(function(book) {
            return book.toLowerCase().indexOf(query) !== -1;
        }).slice(0, 5);

        var suggestionsHtml = suggestions.map(function(book) {
            return '<div class="suggestion-item">' + book + '</div>';
        }).join('');
        $('#book-suggestions').html(suggestionsHtml).show();
    });

    // Click suggestion to fill input
    $('#book-suggestions').on('click', '.suggestion-item', function() {
        $('#book_name').val($(this).text());
        $('#book-suggestions').hide();
    });

    // Hide suggestions when clicking outside
    $(document).click(function(e) {
        if (!$(e.target).closest('#book_name, #book-suggestions').length) {
            $('#book-suggestions').hide();
        }
    });
});
</script>

<style>
.suggestions {
    border: 1px solid #ccc;
    max-width: 300px;
    position: absolute;
    background: white;
    z-index: 1000;
}
.suggestion-item {
    padding: 5px;
    cursor: pointer;
}
.suggestion-item:hover {
    background-color: #eee;
}
</style>
{% endblock %}
